generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String? // Optional for Firebase users
  firstName     String        @default("")
  lastName      String        @default("")
  phone         String        @default("3007189383")
  address       String?       // Address for vCard QR code
  photoUrl      String?       // Profile photo (base64 or URL)
  permissions   String[]      // Permisos individuales (override del rol)
  roleId        String
  role          Role          @relation(fields: [roleId], references: [id])
  firebaseUid   String?       @unique // Firebase UID for Firebase Auth users
  // Portal de Clientes: vincula usuario con un Client para acceso al portal
  portalClientId String?
  portalClient   Client?       @relation("PortalClientUsers", fields: [portalClientId], references: [id])
  models        Model[]
  clients       Client[]      @relation("ClientCreatedBy")
  sharedClients ClientShare[] @relation("SharedClients")
  services      Service[]     @relation("ServiceCreatedBy")
  tasks         Task[]        @relation("TaskCreatedBy")
  // CRM Relations
  ownedDeals         Deal[]         @relation("DealOwner")
  createdDeals       Deal[]         @relation("DealCreatedBy")
  dealActivities     DealActivity[] @relation("ActivityPerformedBy")
  assignedReminders  DealReminder[] @relation("ReminderAssignedTo")
  createdReminders   DealReminder[] @relation("ReminderCreatedBy")
  // Notifications
  receivedNotifications Notification[] @relation("NotificationRecipient")
  sentNotifications     Notification[] @relation("NotificationSender")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Role {
  id            String      @id @default(cuid())
  name          String
  description   String?
  permissions   String[]
  users         User[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Model {
  id          String         @id @default(cuid())
  name        String
  description String?
  type        String
  parameters  Json
  createdBy   String
  createdByUser User        @relation(fields: [createdBy], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Client {
  id          String         @id @default(cuid())
  name        String
  email       String         @unique
  nit         String?
  phone       String?
  address     String?
  logo        String         @default("/img/logo.png")
  status      String         @default("active")
  createdBy   String
  createdByUser User         @relation("ClientCreatedBy", fields: [createdBy], references: [id])
  services    ClientService[]
  sharedWith  ClientShare[]  @relation("ClientShares")
  terceros    Tercero[]      @relation("TerceroClient") // Contactos asociados a este cliente
  accounts    Account[]      @relation("AccountClient")  // Cuentas por cobrar/pagar
  calendarEvents CalendarEvent[]
  // Portal de Clientes
  portalUsers      User[]              @relation("PortalClientUsers")
  portalCampaigns  PortalCampaign[]
  portalBudgets    PortalSalesBudget[]
  portalServices   PortalServiceStatus[]
  portalInvitations PortalInvitation[]
  portalExcelFiles PortalExcelFile[]
  // Meta Ads Integration
  metaAdAccountId  String?   // ID de cuenta publicitaria de Meta (ej: act_123456789)
  metaBusinessId   String?   // ID del Business Manager de Meta
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model ClientShare {
  id        String   @id @default(cuid())
  clientId  String
  userId    String
  client    Client   @relation("ClientShares", fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation("SharedClients", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([clientId, userId])
}

model Service {
  id          String    @id @default(cuid())
  name        String
  description String?
  price       Float
  currency    String    @default("USD")
  duration    String?
  icon        String    @default("Briefcase")
  status      String    @default("active")
  order       Int       @default(0)
  createdBy   String?
  createdByUser User?   @relation("ServiceCreatedBy", fields: [createdBy], references: [id])
  clients     ClientService[]
  deals       Deal[]    // CRM: Deals interesados en este servicio
  portalStatuses PortalServiceStatus[] // Portal: estado del servicio por cliente
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ClientService {
  id                String    @id @default(cuid())
  clientId          String
  serviceId         String
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service           Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Precio y frecuencia de pago
  precioCliente     Float?    // Precio personalizado (override del servicio)
  moneda            String    @default("COP") // Moneda personalizada para este cliente
  frecuencia        String    @default("mensual") // mensual, trimestral, semestral, anual, unico

  // Fechas de control
  fechaInicio       DateTime  @default(now())
  fechaProximoCobro DateTime?
  fechaVencimiento  DateTime?

  // Estado del servicio
  estado            String    @default("activo") // activo, pausado, cancelado
  notas             String?

  // Legacy fields (mantener compatibilidad)
  startDate         DateTime  @default(now())
  endDate           DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([clientId, serviceId])
}

model Task {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      String        @default("pending") // pending, in_progress, completed
  priority    String        @default("medium") // low, medium, high
  dueDate     DateTime?
  position    Int           @default(0) // Para ordenar con drag and drop
  color       String?       // Color personalizado para la tarjeta
  images      String[]      // Array de URLs o Base64 strings de imágenes
  createdBy   String
  createdByUser User        @relation("TaskCreatedBy", fields: [createdBy], references: [id])
  comments    TaskComment[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model TaskComment {
  id        String   @id @default(cuid())
  text      String
  author    String   // Nombre del autor del comentario
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  clientId        String
  clientName      String
  clientNit       String
  totalAmount     Float
  paidAmount      Float    @default(0)
  fecha           DateTime
  concepto        String?
  servicio        String?
  observaciones   String?
  filePath        String   // Ruta del PDF generado
  status          String   @default("pendiente") // pendiente, enviada, parcial, pagada
  paidAt          DateTime?
  payments        InvoicePayment[]
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model InvoicePayment {
  id              String   @id @default(cuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount          Float
  paidAt          DateTime @default(now())
  paymentMethod   String?
  reference       String?
  notes           String?
  createdAt       DateTime @default(now())
}

// ==================== CRM / Pipeline de Ventas ====================

model DealStage {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  position  Int
  color     String   @default("#6B7280")
  isWon     Boolean  @default(false)
  isLost    Boolean  @default(false)
  deals     Deal[]
  fromActivities DealActivity[] @relation("ActivityFromStage")
  toActivities   DealActivity[] @relation("ActivityToStage")
  createdAt DateTime @default(now())
}

model Deal {
  id                String    @id @default(cuid())

  // Relación con Tercero (fuente única de verdad)
  terceroId         String?
  tercero           Tercero?  @relation("DealTercero", fields: [terceroId], references: [id])

  // Campos legacy (se mantienen por compatibilidad hasta migrar datos)
  name              String    // Nombre del contacto
  company           String?   // Empresa/Negocio
  phone             String?   // Número WhatsApp
  phoneCountryCode  String    @default("+57")
  email             String?
  logo              String?   // Logo de la empresa/cliente

  // Pipeline
  stageId           String
  stage             DealStage @relation(fields: [stageId], references: [id])

  // Valor
  estimatedValue    Float?    // Valor estimado mensual
  currency          String    @default("COP")

  // Servicio de interés
  serviceId         String?
  service           Service?  @relation(fields: [serviceId], references: [id])
  serviceNotes      String?   // Notas sobre personalización

  // Fuente y contexto
  source            String?   // referido, pauta, web, evento, llamada_fria, otro
  sourceDetail      String?   // Quién refirió, qué campaña

  // Asignación
  ownerId           String?
  owner             User?     @relation("DealOwner", fields: [ownerId], references: [id])

  // Nuevos campos CRM v2
  probability       Int       @default(50)  // Probabilidad de cierre 0-100
  priority          String    @default("media") // baja, media, alta, urgente
  nextFollowUp      DateTime? // Próximo seguimiento programado
  lastInteractionAt DateTime? // Última interacción registrada
  tags              String[]  // Etiquetas personalizadas

  // Fechas importantes
  firstContactAt       DateTime?
  meetingScheduledAt   DateTime?
  proposalSentAt       DateTime?
  expectedCloseDate    DateTime?
  closedAt             DateTime?

  // Razón de pérdida (si aplica)
  lostReason        String?
  lostNotes         String?

  // Metadata
  notes             String?
  activities        DealActivity[]
  reminders         DealReminder[]
  calendarEvents    CalendarEvent[]

  // Soft delete
  deletedAt         DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdBy         String
  createdByUser     User      @relation("DealCreatedBy", fields: [createdBy], references: [id])
}

model DealActivity {
  id          String     @id @default(cuid())
  dealId      String
  deal        Deal       @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Tipo de actividad: call, whatsapp, email, meeting, note, stage_change
  type        String
  title       String?
  description String?

  // Para cambios de etapa
  fromStageId String?
  fromStage   DealStage? @relation("ActivityFromStage", fields: [fromStageId], references: [id])
  toStageId   String?
  toStage     DealStage? @relation("ActivityToStage", fields: [toStageId], references: [id])

  performedBy   String
  performedByUser User   @relation("ActivityPerformedBy", fields: [performedBy], references: [id])
  performedAt   DateTime @default(now())
}

model DealReminder {
  id          String    @id @default(cuid())
  dealId      String
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  title       String
  remindAt    DateTime

  isCompleted Boolean   @default(false)
  completedAt DateTime?

  assignedTo    String?
  assignedToUser User?  @relation("ReminderAssignedTo", fields: [assignedTo], references: [id])
  createdBy     String
  createdByUser User    @relation("ReminderCreatedBy", fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
}

// ==================== TERCEROS (Fuente Única de Verdad) ====================

model Organizacion {
  id          String    @id @default(cuid())
  nombre      String
  nit         String?   @unique
  direccion   String?
  telefono    String?
  email       String?
  logo        String?
  estado      String    @default("activo") // activo, inactivo
  notas       String?
  terceros    Tercero[] // Personas asociadas a esta organización
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Tercero {
  id              String    @id @default(cuid())

  // Información básica
  nombre          String
  email           String?
  telefono        String?
  telefonoCodigo  String    @default("+57")
  direccion       String?
  documento       String?   // Cédula, NIT personal, pasaporte

  // Tipo de tercero (puede tener múltiples roles)
  esProspecto     Boolean   @default(false)
  esCliente       Boolean   @default(false)
  esProveedor     Boolean   @default(false)
  esEmpleado      Boolean   @default(false)

  // Organización asociada (opcional) - DEPRECADO, usar clientId
  organizacionId  String?
  organizacion    Organizacion? @relation(fields: [organizacionId], references: [id])

  // Cliente asociado (empresa de la vista Clientes)
  clientId        String?
  client          Client?       @relation("TerceroClient", fields: [clientId], references: [id])

  // Campos específicos para proveedores
  categoriaProveedor String?  // Servicios, Software, Marketing, etc.
  cuentaBancaria    String?

  // Campos específicos para empleados
  cargo           String?
  salarioBase     Float?
  fechaIngreso    DateTime?

  // Estado y metadata
  estado          String    @default("activo") // activo, inactivo
  notas           String?
  tags            String[]

  // Relaciones con CRM
  deals           Deal[]    @relation("DealTercero")
  calendarEvents  CalendarEvent[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== NOTIFICACIONES ====================

model Notification {
  id          String    @id @default(cuid())

  // Tipo de notificación
  type        String    // task_assigned, task_completed, deal_assigned, reminder, mention, system
  title       String
  message     String

  // Links para navegación
  link        String?   // URL relativa para navegar al recurso
  resourceId  String?   // ID del recurso relacionado (taskId, dealId, etc)
  resourceType String?  // task, deal, reminder, etc

  // Estado
  isRead      Boolean   @default(false)
  readAt      DateTime?

  // Relaciones
  recipientId String
  recipient   User      @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  senderId    String?   // Puede ser null para notificaciones del sistema
  sender      User?     @relation("NotificationSender", fields: [senderId], references: [id])

  createdAt   DateTime  @default(now())
}

// ==================== CUENTAS (Por Cobrar / Por Pagar) ====================

model Account {
  id              String    @id @default(cuid())

  // Tipo: receivable (por cobrar) o payable (por pagar)
  type            String    // receivable | payable

  // Información del tercero
  entityName      String    // Nombre del cliente/proveedor
  entityLogo      String?   // Logo del cliente/proveedor

  // Relación opcional con Client
  clientId        String?
  client          Client?   @relation("AccountClient", fields: [clientId], references: [id])

  // Monto y moneda
  amount          Float     // Monto a pagar/cobrar
  currency        String    @default("COP")

  // Recurrencia
  isRecurring     Boolean   @default(false)
  frequency       String?   // daily, weekly, biweekly, monthly, quarterly, yearly
  frequencyDays   Int?      // Cada cuantos días (ej: 15 para quincenal personalizado)

  // Fechas
  startDate       DateTime  // Fecha de inicio o fecha única
  nextDueDate     DateTime? // Próxima fecha de vencimiento (calculada)
  endDate         DateTime? // Fecha fin (para recurrencias con límite)

  // Descripción y categoría
  concept         String    // Concepto/descripción del pago
  category        String?   // servicios, salarios, software, marketing, etc.

  // Estado
  status          String    @default("active") // active, paused, completed, cancelled

  // Historial de pagos
  payments        AccountPayment[]

  // Metadata
  notes           String?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model AccountPayment {
  id              String    @id @default(cuid())
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Monto pagado
  amount          Float
  currency        String    @default("COP")

  // Fecha del pago
  paidAt          DateTime  @default(now())
  dueDate         DateTime? // Fecha de vencimiento original

  // Estado y método
  status          String    @default("completed") // completed, pending, partial, failed
  paymentMethod   String?   // transferencia, efectivo, tarjeta, etc.

  // Comprobante
  receiptUrl      String?   // URL o base64 del comprobante
  reference       String?   // Número de referencia/transacción

  notes           String?
  createdAt       DateTime  @default(now())
}

// Calendar Events for meetings/appointments with clients/prospects
model CalendarEvent {
  id              String    @id @default(cuid())
  title           String
  description     String?

  // Date/time
  start           DateTime
  end             DateTime
  allDay          Boolean   @default(false)

  // Type: meeting, call, presentation, follow_up, other
  type            String    @default("meeting")

  // Location (can be physical address or video link)
  location        String?

  // Color for calendar display
  color           String?

  // Related entities (optional)
  clientId        String?
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  dealId          String?
  deal            Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)
  terceroId       String?
  tercero         Tercero?  @relation(fields: [terceroId], references: [id], onDelete: SetNull)

  // Attendees (comma-separated user names or emails)
  attendees       String?

  // Reminders
  reminder        Int?      // Minutes before event to remind

  // Status: scheduled, completed, cancelled
  status          String    @default("scheduled")

  // Created by
  createdBy       String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== PORTAL DE CLIENTES ====================

// Campañas de marketing del cliente (visibles en portal)
model PortalCampaign {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name            String
  platform        String    // facebook, google, instagram, tiktok, linkedin, other
  status          String    @default("active") // active, paused, completed
  budget          Decimal   @db.Decimal(12, 2)
  spent           Decimal   @default(0) @db.Decimal(12, 2)
  impressions     Int       @default(0)
  clicks          Int       @default(0)
  conversions     Int       @default(0)
  ctr             Decimal?  @db.Decimal(5, 2) // Click-through rate
  cpc             Decimal?  @db.Decimal(10, 2) // Cost per click
  cpa             Decimal?  @db.Decimal(10, 2) // Cost per acquisition
  startDate       DateTime
  endDate         DateTime?
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Presupuesto vs Ventas mensual del cliente
model PortalSalesBudget {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  month           Int       // 1-12
  year            Int
  budget          Decimal   @db.Decimal(12, 2) // Presupuesto de marketing
  sales           Decimal   @default(0) @db.Decimal(12, 2) // Ventas generadas
  leads           Int       @default(0) // Leads generados
  customers       Int       @default(0) // Clientes nuevos
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([clientId, month, year])
}

// Estado de servicios contratados (para mostrar en portal)
model PortalServiceStatus {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Relación con servicio del sistema (opcional para servicios personalizados)
  serviceId       String?
  service         Service?  @relation(fields: [serviceId], references: [id])

  name            String    // SEO, Social Media, Email Marketing, Web Development, etc.
  status          String    @default("active") // active, paused, pending, completed
  progress        Int       @default(0) // 0-100
  startDate       DateTime
  endDate         DateTime?
  deliverables    String?   // JSON array of deliverables with status
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Archivos Excel subidos para visualización en el portal
model PortalExcelFile {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name            String    // Nombre del archivo/reporte
  fileName        String    // Nombre original del archivo
  data            Json      // Datos del Excel parseados como JSON
  sheetNames      String[]  // Nombres de las hojas
  description     String?
  uploadedBy      String    // userId del admin que subió

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Invitaciones para usuarios del portal de clientes
model PortalInvitation {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  email           String
  token           String    @unique
  expiresAt       DateTime
  usedAt          DateTime?
  invitedBy       String    // userId del admin que invitó

  createdAt       DateTime  @default(now())
}